#!/usr/bin/env bash

: ${BUILD_NUMBER:=$}

STATSVN_HTML=$1
TEMP_FILE=/tmp/$BUILD_NUMBER-commits_per_author.log


if [ -z "$1" ]
then
  echo "Usage: `basename $0` <path to directory of HTML generated by StatSVN>"
  exit 1
fi

convert_to_json () {
    xmlstarlet sel -t -m '/_:html/_:body/_:dl' -v '_:dd' $1 2> /dev/null | \
        jq --slurp --raw-input 'split("\n") | {
           "Login name": .[0],
           "Total Commits": .[1],
           "Lines of Code": .[2],
           "Most Recent Commit": .[3]}'
}

export -f convert_to_json

ls $STATSVN_HTML/user_* | \
    parallel convert_to_json >> $TEMP_FILE && \
    jq -s '{"commits per author": .}' $TEMP_FILE
